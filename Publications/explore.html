---
layout: page
title: Explore Topics
---

<div id="explore">
  <div id="graph">
    <button id="fitBtn" class="fit-btn" title="Fit to view">Fit</button>
  </div>
  <div id="details">
    <h3>Click a topic to see papers</h3>
    <p>You can also link here with <code>?tag=CFD</code> (or any topic).</p>
  </div>
</div>

<style>
/* Top (graph) / bottom (details) */
#explore {
  display: grid;
  grid-template-rows: auto auto;
  gap: 16px;
}

/* Graph: explicit height + overlay control */
#graph {
  position: relative;
  height: 520px;
  border: 1px solid #eee;
  border-radius: 8px;
  background: rgba(0,0,0,0.02);
  overflow: hidden;
}
.fit-btn{
  position: absolute; right: 8px; top: 8px; z-index: 2;
  font-size: 12px; padding: 4px 8px; border-radius: 6px;
  border: 1px solid rgba(0,0,0,.15); background: #fff; cursor: pointer;
}
.fit-btn:hover{ filter: brightness(0.97); }

/* Details pane */
#details {
  padding: 8px 12px;
  border: 1px solid #eee;
  border-radius: 8px;
}
#details ul { margin: 0; padding-left: 18px; }

/* Links & nodes */
.link { stroke: #000; stroke-opacity: .14; }  /* lower base opacity for cleaner look */
.node { cursor: pointer; }
.node circle { transition: r 120ms ease, opacity 120ms ease; }

/* Labels: white halo for readability over edges */
.node text.label{
  paint-order: stroke fill;
  stroke: rgba(255,255,255,0.95);
  stroke-width: 3px;
  letter-spacing: 0.2px;
  user-select: none;
  pointer-events: none;
  fill: currentColor;
}

.legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
.badge { display:inline-block; padding:3px 6px; border-radius:6px; font-size:12px; border:1px solid rgba(0,0,0,.1); }

@media (prefers-color-scheme: dark){
  #graph  { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,.12); }
  #details{ border-color: rgba(255,255,255,.12); }
  /* keep .link stroke black; halo still white for contrast */
}

/* Taller on narrow screens */
@media (max-width: 900px){
  #graph { height: 58vh; }
}
</style>

<!-- D3 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<script>
(function(){
  var GRAPH_URL = "{{ '/assets/data/topic_graph.json' | relative_url }}";
  var PUBS_URL  = "{{ '/assets/data/pubs.json' | relative_url }}";

  var graphEl   = document.getElementById('graph');
  var detailsEl = document.getElementById('details');
  var fitBtn    = document.getElementById('fitBtn');
  var qs        = new URLSearchParams(location.search);
  var startTag  = qs.get('tag');

  // ---------- bottom panel ----------
  function renderDetails(topic, pubs){
    if(!topic){
      detailsEl.innerHTML = '<h3>Click a topic to see papers</h3><p>You can also link here with <code>?tag=CFD</code> (or any topic).</p>';
      return;
    }
    var filtered = pubs.filter(function(p){
      var tags = (p.tags || []).map(function(t){ return String(t).toLowerCase(); });
      return tags.indexOf(String(topic).toLowerCase()) >= 0;
    });

    var byYear = {};
    filtered.forEach(function(p){
      var y = p.year || '—';
      (byYear[y] = byYear[y] || []).push(p);
    });
    var years = Object.keys(byYear).sort(function(a,b){
      if(b === '—') return -1;
      return (+b) - (+a);
    });

    var html = '<h3>'+topic+'</h3><div class="legend"><span class="badge">Papers: '+filtered.length+'</span></div><ul>';
    years.forEach(function(y){
      byYear[y].sort(function(a,b){ return a.title.localeCompare(b.title); });
      byYear[y].forEach(function(p){
        var venue = p.venue ? ', <em>'+p.venue+'</em>' : '';
        var yearTxt = p.year ? ', '+p.year : '';
        var link = p.url ? ' <a href="'+p.url+'" target="_blank" rel="noopener">[Link]</a>' : '';
        html += '<li>'+p.title+venue+yearTxt+link+'</li>';
      });
    });
    html += '</ul>';
    detailsEl.innerHTML = html;
  }

  // ---------- graph ----------
  function drawGraph(data, pubs){
    if(!data || !data.nodes || data.nodes.length === 0){
      graphEl.innerHTML = '<div style="padding:12px;">No topics found. Ensure BibTeX <code>keywords</code> are present so tags can be generated.</div>';
      return;
    }

    var rect   = graphEl.getBoundingClientRect();
    var width  = rect.width || 800;
    var height = rect.height || 520;

    var svg = d3.select(graphEl).append('svg')
      .attr('width', width)
      .attr('height', height);

    var g = svg.append('g').attr('class', 'viz');

    // Degree (weighted) for color mapping (keep meaning, make it vivid via HCL interpolation)
    var degree = new Map();
    data.nodes.forEach(function(n){ degree.set(n.id, 0); });
    data.links.forEach(function(l){
      var w = l.weight || 1;
      var s = (typeof l.source === 'string') ? l.source : (l.source.id || l.source);
      var t = (typeof l.target === 'string') ? l.target : (l.target.id || l.target);
      degree.set(s, (degree.get(s) || 0) + w);
      degree.set(t, (degree.get(t) || 0) + w);
    });
    var degVals = Array.from(degree.values());
    var extent  = d3.extent(degVals);
    var tScale  = (extent[0] === extent[1])
      ? function(){ return 0.6; }
      : d3.scaleLinear().domain(extent).range([0.1, 1.0]);  // wider, more vivid

    var tealStart = d3.hcl("#CFF3F6");  // brighter aqua
    var tealEnd   = d3.hcl("#006D6F");  // deep teal
    var teal      = d3.interpolateHcl(tealStart, tealEnd);
    function color(id){ return teal(tScale(degree.get(id) || 0)); }

    // --- node size from topic counts (as before) ---
    var topicCount = new Map();
    pubs.forEach(function(p){
      var tags = p.tags || [];
      for (var i=0;i<tags.length;i++){
        var key = String(tags[i]).toLowerCase();
        topicCount.set(key, (topicCount.get(key) || 0) + 1);
      }
    });
    function countFor(id){
      return topicCount.get(String(id).toLowerCase()) || 1;
    }
    var counts = Array.from(topicCount.values());
    var cExtent = (counts.length ? d3.extent(counts) : [1,1]);

    var rScale  = (cExtent[0] === cExtent[1])
      ? function(){ return 10; }
      : d3.scaleSqrt().domain(cExtent).range([8, 22]);

    function nodeR(d){ return rScale(countFor(d.id)); }

    // Helper: stroke width scales with node radius (thicker ring for hubs)
    function ringWidth(d){
      var r = nodeR(d);
      var w = d3.scaleLinear().domain([8,22]).range([1.2, 6])(r);
      return w;
    }

    var linkWidth = d3.scaleLinear()
      .domain(d3.extent(data.links, function(d){ return d.weight || 1; }))
      .range([1.0, 4.0]);

    var sim = d3.forceSimulation(data.nodes)
      .force('link', d3.forceLink(data.links).id(function(d){ return d.id; }).distance(80).strength(0.25))
      .force('charge', d3.forceManyBody().strength(-200))
      .force('center', d3.forceCenter(width/2, height/2))
      .force('x', d3.forceX(width/2).strength(0.05))
      .force('y', d3.forceY(height/2).strength(0.05))
      .force('collision', d3.forceCollide().radius(function(d){ return nodeR(d) + 4; }));

    var link = g.append('g')
      .attr('stroke-linecap','round')
      .selectAll('line')
      .data(data.links)
      .enter().append('line')
      .attr('class','link')
      .attr('stroke-width', function(d){ return linkWidth(d.weight || 1); });

    var node = g.append('g')
      .selectAll('g')
      .data(data.nodes)
      .enter().append('g')
      .attr('class','node')
      .call(d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended)
      );

    // Circle: white fill + colored ring
    node.append('circle')
      .attr('r', function(d){ return nodeR(d); })
      .attr('fill', '#fff')
      .attr('stroke', function(d){ return color(d.id); })
      .attr('stroke-width', function(d){ return ringWidth(d); })
      .on('mouseenter', function(event, d){ highlight(d); })
      .on('mouseleave', function(){ clearHighlight(); })
      .on('dblclick', function(event, d){ d.fx = null; d.fy = null; });
    node.on('click', function(event, d){ selectTopic(d.id); });

    // Label: inside for hubs; outside for small nodes; font scales with radius
    function fontSizeFor(d){
      var fs = nodeR(d) * 0.95;            // proportional
      fs = Math.max(11, Math.min(26, fs)); // clamp
      return fs;
    }
    node.append('text')
      .attr('class','label')
      .text(function(d){ return d.id; })
      .attr('dominant-baseline','middle')
      .attr('text-anchor', function(d){ return (nodeR(d) >= 16) ? 'middle' : 'start'; })
      .attr('x', function(d){ return (nodeR(d) >= 16) ? 0 : (nodeR(d) + 6); })
      .attr('y', 0)
      .attr('font-size', function(d){ return fontSizeFor(d); });

    sim.on('tick', function(){
      link
        .attr('x1', function(d){ return d.source.x; })
        .attr('y1', function(d){ return d.source.y; })
        .attr('x2', function(d){ return d.target.x; })
        .attr('y2', function(d){ return d.target.y; });
      node.attr('transform', function(d){ return 'translate('+d.x+','+d.y+')'; });
    });

    // Zoom/pan
    var zoom = d3.zoom().scaleExtent([0.5, 6]).on('zoom', function(event){ g.attr('transform', event.transform); });
    svg.call(zoom);

    // Fit-to-view with a bit more padding for labels
    function fit(){
      var n = g.node();
      if(!n || !n.getBBox) return;
      var bbox = n.getBBox();
      var dx = bbox.width, dy = bbox.height;
      if(!dx || !dy) return;
      var cx = bbox.x + dx/2, cy = bbox.y + dy/2;
      var scale = 0.88 / Math.max(dx / width, dy / height);  // slightly more padding
      var translate = [width/2 - scale*cx, height/2 - scale*cy];
      svg.transition().duration(500)
        .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
    }

    // Neighbor map for hover highlight
    var neighbors = new Map();
    data.links.forEach(function(l){
      var s = (typeof l.source === 'string') ? l.source : (l.source.id || l.source);
      var t = (typeof l.target === 'string') ? l.target : (l.target.id || l.target);
      if(!neighbors.get(s)) neighbors.set(s, new Set());
      if(!neighbors.get(t)) neighbors.set(t, new Set());
      neighbors.get(s).add(t);
      neighbors.get(t).add(s);
    });

    function highlight(d){
      var ns = neighbors.get(d.id) || new Set();
      node.selectAll('circle')
        .attr('opacity', function(nd){ return (nd.id === d.id || ns.has(nd.id)) ? 1 : 0.25; });
      link.attr('opacity', function(l){
        var s = (typeof l.source === 'object') ? l.source.id : l.source;
        var t = (typeof l.target === 'object') ? l.target.id : l.target;
        return (s === d.id || t === d.id || ns.has(s) || ns.has(t)) ? 0.9 : 0.12;
      });
      node.selectAll('text.label')
        .attr('opacity', function(nd){ return (nd.id === d.id || ns.has(nd.id)) ? 1 : 0.25; });
    }
    function clearHighlight(){
      node.selectAll('circle').attr('opacity', 1);
      link.attr('opacity', 0.14);
      node.selectAll('text.label').attr('opacity', 1);
    }

    function selectTopic(topic){
      renderDetails(topic, pubs);
      node.selectAll('circle').attr('stroke-width', function(nd){
        return (nd.id === topic) ? Math.max(6, ringWidth(nd) + 2) : ringWidth(nd);
      });
      var url = new URL(location);
      url.searchParams.set('tag', topic);
      history.replaceState(null, '', url);
    }

    // Drag handlers
    function dragstarted(event, d){
      if(!event.active) sim.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d){
      d.fx = event.x; d.fy = event.y;
    }
    function dragended(event, d){
      if(!event.active) sim.alphaTarget(0);
      // keep pinned; double-click to unpin
    }

    // Fit after layout stabilizes + once more shortly after
    sim.on('end', function(){ fit(); setTimeout(fit, 300); });

    // Refit on container resize
    if ('ResizeObserver' in window) {
      var ro = new ResizeObserver(function(){
        var r = graphEl.getBoundingClientRect();
        svg.attr('width', r.width || width).attr('height', r.height || height);
        fit();
      });
      ro.observe(graphEl);
    }

    fitBtn.addEventListener('click', function(){ fit(); });

    // Deep-link selection
    if(startTag){
      var datum = data.nodes.find(function(n){ return n.id.toLowerCase() === String(startTag).toLowerCase(); });
      if(datum){ selectTopic(datum.id); }
    }
  }

  // Load data & render
  Promise.all([fetch(GRAPH_URL), fetch(PUBS_URL)])
    .then(function(results){
      var gRes = results[0], pRes = results[1];
      if(!gRes.ok || !pRes.ok) throw new Error('JSON fetch failed');
      return Promise.all([gRes.json(), pRes.json()]);
    })
    .then(function(payloads){
      drawGraph(payloads[0], payloads[1]);
    })
    .catch(function(err){
      console.error(err);
      graphEl.innerHTML = '<div style="padding:12px;color:#b00020">Could not load data. Make sure Actions generated <code>assets/data/topic_graph.json</code> and <code>assets/data/pubs.json</code>.</div>';
    });
})();
</script>
